name: "PR Check - Main"

# This workflow runs basic checks on PRs to main WITHOUT building
# Actual builds are triggered only when merged to main (via release.yml)

on:
  workflow_dispatch:
    # Manual trigger only - no automatic triggers

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-check:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tauri.conf.json
        id: get-version
        run: |
          VERSION=$(grep -o '"version": "[^"]*"' frontend/src-tauri/tauri.conf.json | cut -d'"' -f4)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Check PR source branch
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          echo "PR source branch: $SOURCE_BRANCH"

          if [[ "$SOURCE_BRANCH" == "devtest" ]]; then
            echo "‚úÖ PR from devtest branch - ready for release"
          else
            echo "‚ö†Ô∏è PR from non-devtest branch: $SOURCE_BRANCH"
            echo "Consider merging to devtest first for testing builds"
          fi

      - name: Generate PR summary
        run: |
          echo "## PR to Main - Validation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ÑπÔ∏è Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No builds are triggered for PRs to main." >> $GITHUB_STEP_SUMMARY
          echo "Release builds will automatically start **after this PR is merged**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ What happens on merge:" >> $GITHUB_STEP_SUMMARY
          echo "1. Release workflow triggers automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. All platforms are built (macOS, Windows, Linux)" >> $GITHUB_STEP_SUMMARY
          echo "3. Code signing is applied" >> $GITHUB_STEP_SUMMARY
          echo "4. Draft release is created with all artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const version = '${{ steps.get-version.outputs.version }}';
            const sourceBranch = '${{ github.head_ref }}';

            let body = `## PR to Main - Ready for Review\n\n`;
            body += `**Version:** ${version}\n`;
            body += `**Source Branch:** ${sourceBranch}\n\n`;
            body += `### ‚ÑπÔ∏è Build Information\n\n`;
            body += `No builds are triggered for PRs to main to save CI resources.\n\n`;
            body += `### üöÄ What happens when this PR is merged:\n\n`;
            body += `1. **Release workflow** triggers automatically\n`;
            body += `2. All platforms are built (macOS, Windows, Linux)\n`;
            body += `3. Code signing is applied\n`;
            body += `4. Draft release is created with all artifacts\n\n`;

            if (sourceBranch === 'devtest') {
              body += `‚úÖ **PR from devtest** - Builds were already tested in the devtest pipeline.\n`;
            } else {
              body += `‚ö†Ô∏è **Not from devtest** - Consider testing builds via devtest branch first.\n`;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
